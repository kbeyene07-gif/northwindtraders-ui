<div class="container py-3">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-0">Customers</h2>
      <small class="text-muted">
        Total: {{ totalCount }} customer(s) • Page {{ pageNumber }} • Size {{ pageSize }}
      </small>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="openCreate()">
        + Add Customer
      </button>

      <button class="btn btn-outline-primary" (click)="loadCustomers()" [disabled]="loading">
        <span *ngIf="!loading">Refresh</span>
        <span *ngIf="loading">Loading...</span>
      </button>
    </div>
  </div>

  <!-- Search -->
  <div class="card mb-3">
    <div class="card-body d-flex flex-column flex-md-row gap-2 align-items-md-center">
      <input
        class="form-control"
        type="text"
        placeholder="Search by name, phone, city, country, state, zip..."
        [(ngModel)]="searchText"
        (ngModelChange)="applyFilter()"
      />

      <button class="btn btn-outline-secondary" (click)="clearSearch()" [disabled]="!searchText">
        Clear
      </button>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Paging Controls -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 text-muted">Page size</label>
      <select
        class="form-select form-select-sm"
        style="width: 110px;"
        [(ngModel)]="pageSize"
        (ngModelChange)="pageNumber = 1; loadCustomers()"
      >
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
        <option [ngValue]="50">50</option>
      </select>
    </div>
<button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="loading || pageNumber <= 1">
  ◀ Prev
</button>
 <span class="text-muted small">
    Page <strong>{{ pageNumber }}</strong>
  </span>

<button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="loading || (pageNumber * pageSize) >= totalCount">
  Next ▶
</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 80px;">ID</th>
            <th style="min-width: 220px;">Name</th>
            <th style="min-width: 140px;">Phone</th>
            <th style="min-width: 140px;">City</th>
            <th style="min-width: 120px;">State</th>
            <th style="min-width: 140px;">Country</th>
            <th style="min-width: 110px;">Zip</th>
            <th style="min-width: 160px;">Created</th>
            <th style="min-width: 160px;">Updated</th>
            <th style="width: 170px;">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="loading">
            <td colspan="10" class="p-4 text-center">Loading customers...</td>
          </tr>

          <tr *ngIf="!loading && filteredCustomers.length === 0">
            <td colspan="10" class="p-4 text-center">No customers found.</td>
          </tr>

          <tr *ngFor="let c of filteredCustomers; trackBy: trackById">
            <td>{{ c.id }}</td>

            <td>
              <div class="fw-semibold">{{ c.firstName }} {{ c.lastName }}</div>
              <div class="text-muted small" *ngIf="c.address1 || c.address2">
                {{ c.address1 }}<span *ngIf="c.address1 && c.address2">, </span>{{ c.address2 }}
              </div>
            </td>

            <td>{{ c.phone || '-' }}</td>
            <td>{{ c.city || '-' }}</td>
            <td>{{ c.state || '-' }}</td>
            <td>{{ c.country || '-' }}</td>
            <td>{{ c.zipCode || '-' }}</td>

            <td>{{ c.createdAtUtc | date : 'medium' }}</td>
            <td>{{ c.updatedAtUtc ? (c.updatedAtUtc | date : 'medium') : '-' }}</td>

            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" (click)="openEdit(c)">
                  Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(c)">
                  Delete
                </button>
              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>

  <!-- CREATE / EDIT MODAL -->
  <div class="modal fade show d-block" tabindex="-1" role="dialog" *ngIf="showModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">

        <form #f="ngForm" (ngSubmit)="save(f)">
          <div class="modal-header">
            <h5 class="modal-title">
              {{ modalMode === 'create' ? 'Add Customer' : 'Edit Customer' }}
            </h5>
            <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">

              <div class="col-md-6">
                <label class="form-label">First Name *</label>
                <input
                  class="form-control"
                  name="firstName"
                  [(ngModel)]="formModel.firstName"
                  required
                />
                <div class="text-danger small mt-1" *ngIf="f.submitted && f.controls['firstName']?.invalid">
                  First name is required.
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Last Name *</label>
                <input
                  class="form-control"
                  name="lastName"
                  [(ngModel)]="formModel.lastName"
                  required
                />
                <div class="text-danger small mt-1" *ngIf="f.submitted && f.controls['lastName']?.invalid">
                  Last name is required.
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input class="form-control" name="phone" [(ngModel)]="formModel.phone" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Country</label>
                <input class="form-control" name="country" [(ngModel)]="formModel.country" />
              </div>

              <div class="col-md-4">
                <label class="form-label">City</label>
                <input class="form-control" name="city" [(ngModel)]="formModel.city" />
              </div>

              <div class="col-md-4">
                <label class="form-label">State</label>
                <input class="form-control" name="state" [(ngModel)]="formModel.state" />
              </div>

              <div class="col-md-4">
                <label class="form-label">Zip</label>
                <input class="form-control" name="zipCode" [(ngModel)]="formModel.zipCode" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Address 1</label>
                <input class="form-control" name="address1" [(ngModel)]="formModel.address1" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Address 2</label>
                <input class="form-control" name="address2" [(ngModel)]="formModel.address2" />
              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" (click)="closeModal()" [disabled]="saving">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="saving">
              <span *ngIf="!saving">Save</span>
              <span *ngIf="saving">Saving...</span>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="modal-backdrop fade show" *ngIf="showModal"></div>

  <!-- DELETE CONFIRM MODAL -->
  <div class="modal fade show d-block" tabindex="-1" role="dialog" *ngIf="showDelete">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Confirm delete</h5>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeDelete()"></button>
        </div>

        <div class="modal-body">
          <p class="mb-0">
            Delete customer
            <strong *ngIf="toDelete">{{ toDelete.firstName }} {{ toDelete.lastName }}</strong>
            ?
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="closeDelete()" [disabled]="deleting">
            Cancel
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleting">
            <span *ngIf="!deleting">Delete</span>
            <span *ngIf="deleting">Deleting...</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="modal-backdrop fade show" *ngIf="showDelete"></div>


